{% extends "base.html" %}

{% block title %}Inventario ICOD SAS{% endblock %}

{% block content %}

<h2 class="mb-4">üì¶ Inventario ICOD SAS</h2>

<div class="row">
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">
        <strong>Registrar movimiento</strong>
      </div>
      <div class="card-body">
        <form method="POST">
          <div class="mb-3">
            <label class="form-label">Producto</label>
            <select name="producto" class="form-select" required>
              {% for p in productos %}
                <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="number" name="cantidad" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Tipo</label>
            <select name="tipo" class="form-select" required>
              <option value="entrada">Entrada</option>
              <option value="salida">Salida</option>
            </select>
          </div>

          <button class="btn btn-verde" type="submit">Guardar</button>
        </form>

        <!-- BOT√ìN NUEVO -->
        <form method="POST"
              action="{{ url_for('eliminar_ultimo_producto') }}"
              onsubmit="return confirm('¬øSeguro que desea eliminar el √∫ltimo producto agregado?');"
              class="mt-2">
          <button class="btn btn-danger btn-sm">
            ‚ùå Eliminar √∫ltimo producto agregado
          </button>
        </form>

      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <strong>Acciones</strong>
      </div>
      <div class="card-body">
        <a href="/download_movimientos" class="btn btn-verde mb-2">üì• Descargar Movimientos</a>
        <a href="/download_stock" class="btn btn-verde mb-2">üì• Descargar Stock</a>
    
</a>


 {% if session["rol"] == "admin" %}
<form action="{{ url_for('resetear_inventario') }}" 
      method="POST"
      class="mt-3"
      onsubmit="return confirm('‚ö†Ô∏è ¬øEst√° seguro de resetear TODO el inventario? Esta acci√≥n NO se puede deshacer.')">
  <button class="btn btn-danger">
      üî¥ Resetear inventario
  </button>


{% endif %}

{% if session["rol"] == "admin" %}
<a href="{{ url_for('gestion_usuarios') }}" class="btn btn-verde mb-2">
üë• Gesti√≥n de usuarios
</a>
{% endif %}

</form>

      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">
        <strong>Filtro y b√∫squeda</strong>
      </div>
      <div class="card-body">
        <form method="GET">
          <div class="mb-3">
            <label class="form-label">Categor√≠a</label>
            <select name="categoria" class="form-select" onchange="this.form.submit()">
              {% for cat in categorias %}
                <option value="{{ cat }}" {% if cat == categoria_filtro %}selected{% endif %}>
                  {{ cat }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Buscar producto</label>
            <input type="text" name="buscar" class="form-control" value="{{ buscar }}" placeholder="Ej: tornillo">
          </div>

          <button class="btn btn-amarillo" type="submit">Buscar</button>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <strong>Stock actual</strong>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Categoria</th>
              <th>Unidad</th>
              <th>Stock</th>
            </tr>
          </thead>
          <tbody>
            {% for producto, cantidad in inventario.items() %}
              {% if cantidad > 0 %}
                <tr>
                  <td>{{ producto }}</td>
                  <td>{{ productos_info.get(producto, {}).get("categoria", "Sin categor√≠a") }}</td>
                  <td>{{ productos_info.get(producto, {}).get("unidad", "N/A") }}</td>
                  <td>{{ cantidad }}</td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<hr>

<h3>Movimientos registrados</h3>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Producto</th>
      <th>Categoria</th>
      <th>Unidad</th>
      <th>Cantidad</th>
      <th>Tipo</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody>
    {% for m in movimientos %}
      <tr>
        <td>{{ m.fecha }}</td>
        <td>{{ m.producto }}</td>
        <td>{{ m.categoria }}</td>
        <td>{{ m.unidad }}</td>
        <td>{{ m.cantidad }}</td>
        <td>{{ m.tipo }}</td>
        <td>
          <form method="POST"
                action="{{ url_for('eliminar_movimiento', idx=m.id) }}"
                onsubmit="return confirm('¬øSeguro que desea eliminar este movimiento?');">
            <button class="btn btn-danger btn-sm">üóë</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
